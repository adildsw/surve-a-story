<!DOCTYPE html> 
<html> 
  
<head> 
    <title>Escape</title> 
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <style>
        .middle {
            height: 100%;
        }
    </style>
    <script>
        $(document).ready(function() {
            $('.ui.checkbox').checkbox(); // Emable checkbox clicks

            // Extracts selected answer and performs form validation for progression
            $(document).on("click", "#nextBtn", function() {
                let selection = undefined;
                let item = "<%=item%>";
                let itemCode = "<%=itemCode%>";

                // Extracting input
                console.log(itemCode);
                if (item == "mcq") {
                    selection = $('#mcqInput').find('[name="0"]:checked').val();
                }
                else if (item == "multimcq") {
                    selection = [];
                    for (var i = 0; i < $("#mcqcount").val(); i++) {
                        selection.push($('#mcqInput' + i).find('[name=' + i + ']:checked').val());
                    }
                }
                else if (item == "slider") {
                    selection = $("#sliderInput").val();
                }
                else if (item == "written") {
                    selection = $("#writtenInput").val();
                }
                else if (item == "narrative" || item == "start" || item == "end") {
                    selection = true;
                }
                
                // Null result cleanup
                if (selection == "") {
                    selection = undefined;
                }

                // AJAX POST request for form validation and progression
                var params = {itemCode: "<%=itemCode%>", selection: selection};
                $.post("/next", params, function(response) {
                    document.getElementsByTagName("html")[0].innerHTML = response;
                    window.location = window.location;
                });
            });

            // Allows users to return to the previous story segment
            $(document).on("click", "#backBtn", function() {
                $.post("/back", function(response) {
                    document.getElementsByTagName("html")[0].innerHTML = response;
                    window.location = window.location;
                });
            });
            
            // Dynamically display the slider selection value on slider change
            $("#sliderInput").on('input', function() {
                $("#sliderVal").text($(this).val());
            });
        });
    </script>
</head> 
  
<body> 
    <div class="ui middle aligned grid">
        <div class="eight column wide">
            <div class="ui raised very padded text container segment">
                <div class="ui form" id="module">

                    <% if (item == "mcq") { %>
                        <!-- MCQ Item -->
                        <h2 class="ui header"><%=question%></h2>
                        <% if (imgDir != "" ) { %>
                            <img class="ui fluid image" src="<%=imgDir%>">
                        <% } %>
                        <% if (description != "" ) { %>
                            <p><%=description%></p>
                        <% } %>
                        <div class="grouped fields" id="mcqInput">
                            <% for (var i = 0; i < options.length; i++) { %>
                                <div class="field">
                                    <div class="ui radio checkbox">
                                    <input type="radio" name="0" class="hidden" value="<%=options[i]%>">
                                    <label><%=options[i]%></label>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    
                    <% } else if (item == "multimcq") { %>
                        <!-- Multi MCQ Item -->
                        <input type="hidden" value="<%=question.length%>" id="mcqcount">
                        <% for (var j = 0; j < question.length; j++) { %>
                            <h2 class="ui header"><%=question[j]%></h2>
                            <% if (imgDir[j] != "" ) { %>
                                <img class="ui fluid image" src="<%=imgDir[j]%>">
                            <% } %>
                            <% if (description[j] != "" ) { %>
                                <p><%=description[j]%></p>
                            <% } %>
                            <div class="grouped fields" id="mcqInput<%=j%>">
                                <% for (var i = 0; i < options[j].length; i++) { %>
                                    <div class="field">
                                        <div class="ui radio checkbox">
                                        <input type="radio" name="<%=j%>" class="hidden" value="<%=options[j][i]%>">
                                        <label><%=options[j][i]%></label>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                            <% if (j < question.length - 1) { %>
                                <div class="ui horizontal divider">â€¢</div>
                            <% } %>
                        <% } %>

                    <% } else if (item == "slider") { %>
                        <!-- Range Slider Item -->
                        <h2 class="ui header"><%=question%></h2>
                        <% if (imgDir != "" ) { %>
                            <img class="ui fluid image" src="<%=imgDir%>">
                        <% } %>
                        <% if (description != "" ) { %>
                            <p><%=description%></p>
                        <% } %>
                        <div class="inline fields">
                            <input type="range" min="<%=min%>" max="<%=max%>" value="<%=min%>" style="width:95%;" id="sliderInput">
                            <span>&nbsp;&nbsp;</span>
                            <span id="sliderVal"><%=min%></span>
                        </div>

                    <% } else if (item == "written") { %>
                        <!-- Written Answer Item -->
                        <h2 class="ui header"><%=question%></h2>
                        <% if (imgDir != "" ) { %>
                            <img class="ui fluid image" src="<%=imgDir%>">
                        <% } %>
                        <% if (description != "" ) { %>
                            <p><%=description%></p>
                        <% } %>
                        <div class="ui input labeled fluid focus">
                            <input type="text" id="writtenInput" style="margin-bottom: 15px;" placeholder="Your Answer">
                        </div>
                    
                    <% } else if (item == "narrative") { %>
                        <!-- Narrative Item -->
                        <% for (var i = 0; i < objectType.length; i++) { %>
                            <% if (objectType[i] == "title" ) { %>
                                <h2 class="ui header"><%=objectDescription[i]%></h2>
                            <% } else if (objectType[i] == "info" ) { %>
                                <p><%=objectDescription[i]%></p>
                            <% } else if (objectType[i] == "image" ) { %>
                                <img class="ui fluid image" src="<%=objectDescription[i]%>">
                            <% } %>
                        <% } %>

                    <% } else if (item == "start" || item == "end") { %>
                        <!-- Start/End Item -->
                        <h2 class="ui header centered"><%=title%></h2>
                        <% if (imgDir != "" ) { %>
                            <img class="ui fluid image" src="<%=imgDir%>">
                        <% } %>
                        <% if (description != "" ) { %>
                            <p><%=description%></p>
                        <% } %>
                    <% } %>

                    <!-- Control Buttons -->
                    <% if (item != "end") { %>
                        <button class="ui fluid teal button" id="nextBtn">
                            <% if (item == "start") { %>
                                Begin
                            <% } else { %>
                                Next
                            <% } %>
                        </button>
                    <% } else {%>
                        <button class="ui fluid green button" id="downloadLogBtn">Download Playthrough Log</button>
                    <% } %>

                    <% if (item != "start" && item != "end") { %>
                        <% if (backBtn) { %>
                            <button style="margin-top: 2px;" class="ui fluid button" id="backBtn">Back</button>
                        <% } %>
                    <% } %>

                </div>
            </div>
        </div>
    </div>
</body>

</html>